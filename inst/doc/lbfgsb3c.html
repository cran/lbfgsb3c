<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="John C Nash Telfer School of Management, University of Ottawa, nashjc@uottawa.ca" />

<meta name="date" content="2019-10-22" />

<title>lbfgsb3c: Using the 2011 version of L-BFGS-B.</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>
<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">lbfgsb3c: Using the 2011 version of L-BFGS-B.</h1>
<h4 class="author">John C Nash Telfer School of Management, University of Ottawa, <a href="mailto:nashjc@uottawa.ca" class="email">nashjc@uottawa.ca</a></h4>
<h4 class="date">October 22, 2019</h4>



<div id="abstract" class="section level1">
<h1>Abstract</h1>
<p>In 2011 the authors of the L-BFGSB program published a correction and update to their 1995 code. The latter is the basis of the L-BFGS-B method of the <code>optim()</code> function in base-R. The package <code>lbfgsb3</code> wrapped the updated code using a <code>.Fortran</code> call after removing a very large number of Fortran output statements. Matthew Fidler used this Fortran code and an <code>Rcpp</code> interface to produce package <code>lbfgsb3c</code> where the function <code>lbfgsb3c()</code> returns an object similar to that of base-R <code>optim()</code> and that of <code>optimx::optimr()</code>. Subsequently, in a fine example of the collaborations that have made <strong>R</strong> so useful, we have merged the functionality of package <code>lbfgsb3</code> into <code>lbfgsb3c</code>, as explained in this vignette. Note that this document is intended primarily to document our efforts to check the differences in variants of the code rather than be expository.</p>
<div id="provenance-of-the-r-optiml-bfgs-b-and-related-solvers" class="section level2">
<h2>Provenance of the R optim::L-BFGS-B and related solvers</h2>
<p>The base-R code lbfgsb.c (at writing in R-3.5.2/src/appl/) is commented:</p>
<pre><code>/* l-bfgs-b.f -- translated by f2c (version 19991025).

  From ?optim:
  The code for method ‘&quot;L-BFGS-B&quot;’ is based on Fortran code by Zhu,
  Byrd, Lu-Chen and Nocedal obtained from Netlib (file &#39;opt/lbfgs_bcm.shar&#39;)

  The Fortran files contained no copyright information.

  Byrd, R. H., Lu, P., Nocedal, J. and Zhu, C.  (1995) A limited
  memory algorithm for bound constrained optimization.
  \emph{SIAM J. Scientific Computing}, \bold{16}, 1190--1208.
*/</code></pre>
<p>The paper <span class="citation">R. H. Byrd, Lu, Nocedal, and Zhu (1995b)</span> builds on <span class="citation">Lu et al. (1994)</span>. There have been a number of other workers who have followed-up on this work, but <strong>R</strong> code and packages seem to have largely stayed with codes derived from these original papers. Though the date of the paper is 1995, the ideas it embodies were around for a decade and a half at least, in particular in Nocedal80 and LiuN89. The definitive Fortran code was published as <span class="citation">Zhu et al. (1997)</span>. This is available as <code>toms/778.zip</code> on www.netlib.org. A side-by-side comparison of the main subroutines in the two downloads from Netlib unfortunately shows a lot of differences. I have not tried to determine if these affect performance or are simply cosmetic.</p>
<p>More seriously perhaps, there were some deficiencies in the code(s), and in 2011 Nocedal’s team published a Fortran code with some corrections (<span class="citation">Morales and Nocedal (2011)</span>). Since the <strong>R</strong> code predates this, I prepared package <code>lbfgsb3</code> (<span class="citation">Nash et al. (2015)</span>) to wrap the Fortran code. However, I did not discover any test cases where the <code>optim::L-BFGS-B</code> and <code>lbfgsb3</code> were different, though I confess to only running some limited tests. There are, in fact, more in this vignette.</p>
<p>In 2016, I was at a Fields Institute optimization conference in Toronto for the 70th birthday of Andy Conn. By sheer serendipity, Nocedal did not attend the conference, but sat down next to me at the conference dinner. When I asked him about the key changes, he said that the most important one was to fix the computation of the machine precision, which was not always correct in the 1995 code. Since <strong>R</strong> gets this number as <code>.Machine$double.eps</code>, the offending code is irrelevant.</p>
<p>Within <span class="citation">Morales and Nocedal (2011)</span>, there is also reported an improvement in the subspace minimization that is applied in cases of bounds constraints. Since few of the tests I have applied impose such constraints, it is reasonable that I will not have observed performance differences between the base-R <code>optim</code> code and my <code>lbfsgb3</code> package. More appropriate tests are welcome, and on my agenda.</p>
<p>Besides the ACM TOMS code, there are two related codes from the Northwestern team on NETLIB: <a href="https://netlib.org/opt/lbfgs_um.shar" class="uri">https://netlib.org/opt/lbfgs_um.shar</a> is for unconstrained minimization, while <a href="https://netlib.org/opt/lbfgs_bcm.shar" class="uri">https://netlib.org/opt/lbfgs_bcm.shar</a> handles bounds constrained problems. To these are attached references <span class="citation">Liu and Nocedal (1989)</span> and <span class="citation">R. H. Byrd, Lu, Nocedal, and Zhu (1995a)</span> respectively, most likely reflecting the effort required to implement the constraints.</p>
<p>The unconstrained code has been converted to <strong>C</strong> under the leadership of Naoaki Okazaki (see <a href="http://www.chokkan.org/software/liblbfgs/" class="uri">http://www.chokkan.org/software/liblbfgs/</a>, or the fork at <a href="https://github.com/MIRTK/LBFGS" class="uri">https://github.com/MIRTK/LBFGS</a>). This has been wrapped for <strong>R</strong> as <span class="citation">Coppola, Stewart, and Okazaki (2014)</span> as the <code>lbfgs</code> package. This can be called from <code>optimx::optimr()</code>.</p>
<p>Using Rcpp (see <span class="citation">Eddelbuettel and François (2011)</span>) and the Fortran code in package <code>lbfgs3</code>, Matthew Fidler developed package <code>lbfgsb3c</code> (<span class="citation">Fidler et al. (2018)</span>). As this provides a more standard call and return than <code>lbfgsb3</code> Fidler and I are unified the two packages and released them both under the same name <code>lbfgsb3c</code>.</p>
</div>
<div id="functions-in-package-lbfgsb3c" class="section level2">
<h2>Functions in package <code>lbfgsb3c</code></h2>
<p>There is really only one optimizer function in the package, but it may be called by four (4) names:</p>
<ul>
<li><code>lbfgsb3c()</code> uses Rcpp (<span class="citation">Eddelbuettel (2013)</span>, <span class="citation">Eddelbuettel and François (2011)</span>, <span class="citation">Eddelbuettel and Balamuta (2017)</span>) to streamline the call to the underlying Fortran. This is the base function used.</li>
<li><code>lbfgsb3x()</code> is an alias of <code>lbfgsb3c()</code>. We were using this name for a while, and have kept the alias to avoid having to edit test scripts.</li>
<li><code>lbfgsb3</code>, which imitates a <code>.Fortran</code> call of the compiled 2011 Fortran code. The object returned by this routine is NOT equivalent to the object returned by base-R <code>optim()</code> or by <code>optimx::optimr()</code>. Instead, it includes a structure <code>info</code> which contains the detailed diagnostic information of the Fortran code. For most users, this is not of interest, and I only recommend use of this function for those needing to examine how the optimization has been carried out.</li>
<li><code>lbfgsb3f()</code> is an alias of <code>lbfsgb3()</code>.</li>
</ul>
<p>We recommend using the <code>lbfsgb3c()</code> call for most uses.</p>
<div id="candlestick-function" class="section level3">
<h3>Candlestick function</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="co"># candlestick function</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="co"># J C Nash 2011-2-3</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>cstick.f&lt;-<span class="cf">function</span>(x,<span class="dt">alpha=</span><span class="dv">100</span>){</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>  x&lt;-<span class="kw">as.vector</span>(x)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>  r2&lt;-<span class="kw">crossprod</span>(x)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>  f&lt;-<span class="kw">as.double</span>(r2<span class="op">+</span>alpha<span class="op">/</span>r2)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>  <span class="kw">return</span>(f)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>}</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>cstick.g&lt;-<span class="cf">function</span>(x,<span class="dt">alpha=</span><span class="dv">100</span>){</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>  x&lt;-<span class="kw">as.vector</span>(x)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>  r2&lt;-<span class="kw">as.numeric</span>(<span class="kw">crossprod</span>(x))</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>  g1&lt;-<span class="dv">2</span><span class="op">*</span>x</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>  g2 &lt;-<span class="st"> </span>(<span class="op">-</span>alpha)<span class="op">*</span><span class="dv">2</span><span class="op">*</span>x<span class="op">/</span>(r2<span class="op">*</span>r2)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a>  g&lt;-<span class="kw">as.double</span>(g1<span class="op">+</span>g2)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a>  <span class="kw">return</span>(g)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a>}</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a><span class="kw">library</span>(lbfgsb3c)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true"></a>nn &lt;-<span class="st"> </span><span class="dv">2</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true"></a>x0 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true"></a>lo &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true"></a>up &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true"></a><span class="kw">print</span>(x0)</span></code></pre></div>
<pre><code>## [1] 10 10</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="co">## c2o &lt;- opm(x0, cstick.f, cstick.g, lower=lo, upper=up, method=meths, control=list(trace=0))</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="co">## print(summary(c2o, order=value))</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>c2l1 &lt;-<span class="st"> </span><span class="kw">lbfgsb3c</span>(x0, cstick.f, cstick.g, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>c2l1</span></code></pre></div>
<pre><code>## $par
## [1] 2.236068 2.236068
## 
## $grad
## [1] -1.121272e-06 -1.121272e-06
## 
## $value
## [1] 20
## 
## $counts
## [1] 14 14
## 
## $convergence
## [1] 0
## 
## $message
## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH&quot;</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="co">## meths &lt;- c(&quot;L-BFGS-B&quot;, &quot;lbfgsb3c&quot;, &quot;Rvmmin&quot;, &quot;Rcgmin&quot;, &quot;Rtnmin&quot;)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="co">## require(optimx)</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="co">## cstick2a &lt;- opm(x0, cstick.f, cstick.g, method=meths, upper=up, lower=lo, control=list(kkt=FALSE))</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="co">## print(summary(cstick2a, par.select=1:2, order=value))</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>lo &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">4</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a><span class="co">## c2ob &lt;- opm(x0, cstick.f, cstick.g, lower=lo, upper=up, method=meths, control=list(trace=0))</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a><span class="co">## print(summary(c2ob, order=value))</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>c2l2 &lt;-<span class="st"> </span><span class="kw">lbfgsb3c</span>(x0, cstick.f, cstick.g, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>c2l2</span></code></pre></div>
<pre><code>## $par
## [1] 4 4
## 
## $grad
## [1] 7.21875 7.21875
## 
## $value
## [1] 35.125
## 
## $counts
## [1] 2 2
## 
## $convergence
## [1] 0
## 
## $message
## [1] &quot;CONVERGENCE: NORM_OF_PROJECTED_GRADIENT_&lt;=_PGTOL&quot;</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="co">## cstick2b &lt;- opm(x0, cstick.f, cstick.g, method=meths, upper=up, lower=lo, control=list(kkt=FALSE))</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a><span class="co">## print(summary(cstick2b, par.select=1:2, order=value))</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a><span class="co">## nn &lt;- 100</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a><span class="co">## x0 &lt;- rep(10, nn)</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a><span class="co">## up &lt;- rep(10, nn)</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a><span class="co">## lo &lt;- rep(1e-4, nn)</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a><span class="co">## cco &lt;- opm(x0, cstick.f, cstick.g, lower=lo, upper=up, method=meths, control=list(trace=0, kkt=FALSE))</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a><span class="co">## print(summary(cco, par.select=1:4, order=value))</span></span></code></pre></div>
</div>
<div id="extended-rosenbrock-function-from-funconstrain" class="section level3">
<h3>Extended Rosenbrock function (from funconstrain)</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="co"># require(funconstrain) ## not in CRAN, so explicit inclusion of this function</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a><span class="co"># exrosen &lt;- ex_rosen()</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a><span class="co"># exrosenf &lt;- exrosen$fn</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>exrosenf &lt;-<span class="st"> </span><span class="cf">function</span> (par) {</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>    n &lt;-<span class="st"> </span><span class="kw">length</span>(par)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a>    <span class="cf">if</span> (n<span class="op">%%</span><span class="dv">2</span> <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) {</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a>        <span class="kw">stop</span>(<span class="st">&quot;Extended Rosenbrock: n must be even&quot;</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a>    }</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a>    fsum &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(n<span class="op">/</span><span class="dv">2</span>)) {</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true"></a>        p2 &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>i</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true"></a>        p1 &lt;-<span class="st"> </span>p2 <span class="op">-</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true"></a>        f_p1 &lt;-<span class="st"> </span><span class="dv">10</span> <span class="op">*</span><span class="st"> </span>(par[p2] <span class="op">-</span><span class="st"> </span>par[p1]<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true"></a>        f_p2 &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>par[p1]</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true"></a>        fsum &lt;-<span class="st"> </span>fsum <span class="op">+</span><span class="st"> </span>f_p1 <span class="op">*</span><span class="st"> </span>f_p1 <span class="op">+</span><span class="st"> </span>f_p2 <span class="op">*</span><span class="st"> </span>f_p2</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true"></a>    }</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true"></a>    fsum</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true"></a>}</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true"></a><span class="co"># exroseng &lt;- exrosen$gr</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true"></a>exroseng &lt;-<span class="st"> </span><span class="cf">function</span> (par) {</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true"></a>    n &lt;-<span class="st"> </span><span class="kw">length</span>(par)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true"></a>    <span class="cf">if</span> (n<span class="op">%%</span><span class="dv">2</span> <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) {</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true"></a>        <span class="kw">stop</span>(<span class="st">&quot;Extended Rosenbrock: n must be even&quot;</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true"></a>    }</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true"></a>    grad &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">0</span>, n)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(n<span class="op">/</span><span class="dv">2</span>)) {</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true"></a>        p2 &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>i</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true"></a>        p1 &lt;-<span class="st"> </span>p2 <span class="op">-</span><span class="st"> </span><span class="dv">1</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true"></a>        xx &lt;-<span class="st"> </span>par[p1] <span class="op">*</span><span class="st"> </span>par[p1]</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true"></a>        yx &lt;-<span class="st"> </span>par[p2] <span class="op">-</span><span class="st"> </span>xx</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true"></a>        f_p1 &lt;-<span class="st"> </span><span class="dv">10</span> <span class="op">*</span><span class="st"> </span>yx</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true"></a>        f_p2 &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span>par[p1]</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true"></a>        grad[p1] &lt;-<span class="st"> </span>grad[p1] <span class="op">-</span><span class="st"> </span><span class="dv">400</span> <span class="op">*</span><span class="st"> </span>par[p1] <span class="op">*</span><span class="st"> </span>yx <span class="op">-</span><span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>f_p2</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true"></a>        grad[p2] &lt;-<span class="st"> </span>grad[p2] <span class="op">+</span><span class="st"> </span><span class="dv">200</span> <span class="op">*</span><span class="st"> </span>yx</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true"></a>    }</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true"></a>    grad</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true"></a>}</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true"></a></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true"></a>exrosenx0 &lt;-<span class="st"> </span><span class="cf">function</span> (<span class="dt">n =</span> <span class="dv">20</span>) {</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true"></a>    <span class="cf">if</span> (n<span class="op">%%</span><span class="dv">2</span> <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) {</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true"></a>        <span class="kw">stop</span>(<span class="st">&quot;Extended Rosenbrock: n must be even&quot;</span>)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true"></a>    }</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true"></a>    <span class="kw">rep</span>(<span class="kw">c</span>(<span class="op">-</span><span class="fl">1.2</span>, <span class="dv">1</span>), n<span class="op">/</span><span class="dv">2</span>)</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true"></a>}</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true"></a></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true"></a></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true"></a><span class="kw">require</span>(lbfgsb3c)</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true"></a><span class="co">## require(optimx)</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true"></a></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true"></a><span class="co">## require(optimx)</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true"></a><span class="cf">for</span> (n <span class="cf">in</span> <span class="kw">seq</span>(<span class="dv">2</span>,<span class="dv">12</span>, <span class="dt">by=</span><span class="dv">2</span>)) {</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true"></a>  <span class="kw">cat</span>(<span class="st">&quot;ex_rosen try for n=&quot;</span>,n,<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true"></a>  x0 &lt;-<span class="st"> </span><span class="kw">exrosenx0</span>(n)</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true"></a>  lo &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="op">-</span><span class="fl">1.5</span>, n)</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true"></a>  up &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">3</span>, n)</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true"></a>  <span class="kw">print</span>(x0)</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true"></a>  <span class="kw">cat</span>(<span class="st">&quot;optim L-BFGS-B</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true"></a>  eo &lt;-<span class="st"> </span><span class="kw">optim</span>(x0, exrosenf, exroseng, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up, <span class="dt">method=</span><span class="st">&quot;L-BFGS-B&quot;</span>, <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">trace=</span><span class="dv">0</span>))</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true"></a>  <span class="kw">print</span>(eo)</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true"></a>  <span class="kw">cat</span>(<span class="st">&quot;lbfgsb3c</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true"></a>  el &lt;-<span class="st"> </span><span class="kw">lbfgsb3c</span>(x0, exrosenf, exroseng, <span class="dt">lower=</span>lo, <span class="dt">upper=</span>up, <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">trace=</span><span class="dv">0</span>))</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true"></a>  <span class="kw">print</span>(el)</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true"></a><span class="co">##    erfg &lt;- opm(x0, exrosenf, exroseng, method=meths, lower=lo, upper=up)</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true"></a><span class="co">##    print(summary(erfg, par.select=1:2, order=value))</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true"></a>}</span></code></pre></div>
<pre><code>## ex_rosen try for n= 2 
## [1] -1.2  1.0
## optim L-BFGS-B
## $par
## [1] 1 1
## 
## $value
## [1] 3.844416e-14
## 
## $counts
## function gradient 
##       51       51 
## 
## $convergence
## [1] 0
## 
## $message
## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot;
## 
## lbfgsb3c
## $par
## [1] 1 1
## 
## $grad
## [1] -8.65458e-07  6.26284e-07
## 
## $value
## [1] 3.844419e-14
## 
## $counts
## [1] 51 51
## 
## $convergence
## [1] 0
## 
## $message
## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH&quot;
## 
## ex_rosen try for n= 4 
## [1] -1.2  1.0 -1.2  1.0
## optim L-BFGS-B
## $par
## [1] 1 1 1 1
## 
## $value
## [1] 7.688835e-14
## 
## $counts
## function gradient 
##       51       51 
## 
## $convergence
## [1] 0
## 
## $message
## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot;
## 
## lbfgsb3c
## $par
## [1] 1 1 1 1
## 
## $grad
## [1] -8.65458e-07  6.26284e-07 -8.65458e-07  6.26284e-07
## 
## $value
## [1] 7.688829e-14
## 
## $counts
## [1] 51 51
## 
## $convergence
## [1] 0
## 
## $message
## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH&quot;
## 
## ex_rosen try for n= 6 
## [1] -1.2  1.0 -1.2  1.0 -1.2  1.0
## optim L-BFGS-B
## $par
## [1] 1 1 1 1 1 1
## 
## $value
## [1] 1.153325e-13
## 
## $counts
## function gradient 
##       51       51 
## 
## $convergence
## [1] 0
## 
## $message
## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot;
## 
## lbfgsb3c
## $par
## [1] 1 1 1 1 1 1
## 
## $grad
## [1] -8.654581e-07  6.262840e-07 -8.654581e-07  6.262840e-07 -8.654581e-07
## [6]  6.262840e-07
## 
## $value
## [1] 1.153324e-13
## 
## $counts
## [1] 51 51
## 
## $convergence
## [1] 0
## 
## $message
## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH&quot;
## 
## ex_rosen try for n= 8 
## [1] -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0
## optim L-BFGS-B
## $par
## [1] 1 1 1 1 1 1 1 1
## 
## $value
## [1] 1.537767e-13
## 
## $counts
## function gradient 
##       51       51 
## 
## $convergence
## [1] 0
## 
## $message
## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot;
## 
## lbfgsb3c
## $par
## [1] 1 1 1 1 1 1 1 1
## 
## $grad
## [1] -8.65458e-07  6.26284e-07 -8.65458e-07  6.26284e-07 -8.65458e-07
## [6]  6.26284e-07 -8.65458e-07  6.26284e-07
## 
## $value
## [1] 1.537766e-13
## 
## $counts
## [1] 51 51
## 
## $convergence
## [1] 0
## 
## $message
## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH&quot;
## 
## ex_rosen try for n= 10 
##  [1] -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0
## optim L-BFGS-B
## $par
##  [1] 1 1 1 1 1 1 1 1 1 1
## 
## $value
## [1] 1.922208e-13
## 
## $counts
## function gradient 
##       51       51 
## 
## $convergence
## [1] 0
## 
## $message
## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot;
## 
## lbfgsb3c
## $par
##  [1] 1 1 1 1 1 1 1 1 1 1
## 
## $grad
##  [1] -8.654582e-07  6.262840e-07 -8.654582e-07  6.262840e-07 -8.654582e-07
##  [6]  6.262840e-07 -8.654582e-07  6.262840e-07 -8.654582e-07  6.262840e-07
## 
## $value
## [1] 1.922207e-13
## 
## $counts
## [1] 51 51
## 
## $convergence
## [1] 0
## 
## $message
## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH&quot;
## 
## ex_rosen try for n= 12 
##  [1] -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0
## optim L-BFGS-B
## $par
##  [1] 1 1 1 1 1 1 1 1 1 1 1 1
## 
## $value
## [1] 2.306652e-13
## 
## $counts
## function gradient 
##       51       51 
## 
## $convergence
## [1] 0
## 
## $message
## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH&quot;
## 
## lbfgsb3c
## $par
##  [1] 1 1 1 1 1 1 1 1 1 1 1 1
## 
## $grad
##  [1] -8.654581e-07  6.262840e-07 -8.654581e-07  6.262840e-07 -8.654581e-07
##  [6]  6.262840e-07 -8.654581e-07  6.262840e-07 -8.654581e-07  6.262840e-07
## [11] -8.654581e-07  6.262840e-07
## 
## $value
## [1] 2.306649e-13
## 
## $counts
## [1] 51 51
## 
## $convergence
## [1] 0
## 
## $message
## [1] &quot;CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH&quot;</code></pre>
</div>
</div>
<div id="using-compiled-function-code" class="section level2">
<h2>Using compiled function code</h2>
<p>While you may use the same interface as described in the writing R extensions to interface compiled code with this function, see <a href="https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Optimization">L-BFGS-B</a>, it is sometimes more convenient to use your own compiled code.</p>
<p>The following example shows how this is done using the file <code>jrosen.f</code>. We have unfortunately found that compilation is not always portable across systems, so this example is presented without execution.</p>
<pre><code>       subroutine rosen(n, x, fval)
       double precision x(n), fval, dx
       integer n, i
       fval = 0.0D0
       do 10 i=1,(n-1)
          dx = x(i + 1) - x(i) * x(i)
          fval = fval + 100.0 * dx * dx
          dx = 1.0 - x(i)
          fval = fval + dx * dx
 10    continue
       return
       end</code></pre>
<p>Here is the example script. Note that we must have the file <code>jrosen.f</code> available. Because the executable files on different systems use different conventions and structures, we have turned evaluation off here so this vignette can be built on multiple platforms. However, we wished to provide examples of how compiled code could be used.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="kw">system</span>(<span class="st">&quot;R CMD SHLIB jrosen.f&quot;</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a><span class="kw">dyn.load</span>(<span class="st">&quot;jrosen.so&quot;</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a><span class="kw">is.loaded</span>(<span class="st">&quot;rosen&quot;</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>x0 &lt;-<span class="st"> </span><span class="kw">as.double</span>(<span class="kw">c</span>(<span class="op">-</span><span class="fl">1.2</span>,<span class="dv">1</span>))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>fv &lt;-<span class="st"> </span><span class="kw">as.double</span>(<span class="op">-</span><span class="dv">999</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a>n &lt;-<span class="st"> </span><span class="kw">as.double</span>(<span class="dv">2</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a>testf &lt;-<span class="st"> </span><span class="kw">.Fortran</span>(<span class="st">&quot;rosen&quot;</span>, <span class="dt">n=</span><span class="kw">as.integer</span>(n), <span class="dt">x=</span><span class="kw">as.double</span>(x0), <span class="dt">fval=</span><span class="kw">as.double</span>(fv))</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a>testf</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a>rrosen &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a>  fval &lt;-<span class="st"> </span><span class="fl">0.0</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>(n<span class="dv">-1</span>)) {</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a>    dx &lt;-<span class="st"> </span>x[i <span class="op">+</span><span class="st"> </span><span class="dv">1</span>] <span class="op">-</span><span class="st"> </span>x[i] <span class="op">*</span><span class="st"> </span>x[i]</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a>    fval &lt;-<span class="st"> </span>fval <span class="op">+</span><span class="st"> </span><span class="fl">100.0</span> <span class="op">*</span><span class="st"> </span>dx <span class="op">*</span><span class="st"> </span>dx</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true"></a>    dx &lt;-<span class="st"> </span><span class="fl">1.0</span> <span class="op">-</span><span class="st"> </span>x[i]</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true"></a>    fval &lt;-<span class="st"> </span>fval <span class="op">+</span><span class="st"> </span>dx <span class="op">*</span><span class="st"> </span>dx</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true"></a>  }</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true"></a>  fval</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true"></a>}</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true"></a>(<span class="kw">rrosen</span>(x0))</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true"></a>frosen &lt;-<span class="st"> </span><span class="cf">function</span>(x){</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true"></a>  nn &lt;-<span class="st"> </span><span class="kw">length</span>(x)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true"></a>  <span class="cf">if</span> (nn <span class="op">&gt;</span><span class="st"> </span><span class="dv">100</span>) { <span class="kw">stop</span>(<span class="st">&quot;max number of parameters is 100&quot;</span>)}</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true"></a>  fv &lt;-<span class="st"> </span><span class="fl">-999.0</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true"></a>  val &lt;-<span class="st"> </span><span class="kw">.Fortran</span>(<span class="st">&quot;rosen&quot;</span>, <span class="dt">n=</span><span class="kw">as.integer</span>(nn), <span class="dt">x=</span><span class="kw">as.double</span>(x), <span class="dt">fval=</span><span class="kw">as.double</span>(fv))</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true"></a>  val<span class="op">$</span>fval <span class="co"># </span><span class="al">NOTE</span><span class="co">--need ONLY function value returned</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true"></a>}</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true"></a><span class="co"># Test the funcion</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true"></a>tval &lt;-<span class="st"> </span><span class="kw">frosen</span>(x0)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true"></a><span class="kw">str</span>(tval)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true"></a><span class="kw">cat</span>(<span class="st">&quot;Run with Nelder-Mead using R function</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true"></a>mynm &lt;-<span class="st"> </span><span class="kw">optim</span>(x0, rrosen, <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">trace=</span><span class="dv">0</span>))</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true"></a><span class="kw">print</span>(mynm)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true"></a><span class="kw">cat</span>(<span class="st">&quot;</span><span class="ch">\n\n</span><span class="st"> Run with Nelder-Mead using Fortran function&quot;</span>)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true"></a>mynmf &lt;-<span class="st"> </span><span class="kw">optim</span>(x0, frosen, <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">trace=</span><span class="dv">0</span>))</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true"></a><span class="kw">print</span>(mynmf)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true"></a></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true"></a><span class="kw">library</span>(lbfgsb3c)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true"></a><span class="kw">library</span>(microbenchmark)</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true"></a><span class="kw">cat</span>(<span class="st">&quot;try lbfgsb3c, no Gradient </span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true"></a><span class="kw">cat</span>(<span class="st">&quot;R function</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true"></a>tlR&lt;-<span class="kw">microbenchmark</span>(myopR &lt;-<span class="st"> </span><span class="kw">lbfgsb3c</span>(x0, rrosen, <span class="dt">gr=</span><span class="ot">NULL</span>, <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">trace=</span><span class="dv">0</span>)))</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true"></a><span class="kw">print</span>(tlR)</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true"></a><span class="kw">print</span>(myopR)</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true"></a><span class="kw">cat</span>(<span class="st">&quot;Fortran function</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true"></a>tlF&lt;-<span class="kw">microbenchmark</span>(myop &lt;-<span class="st"> </span><span class="kw">lbfgsb3c</span>(x0, frosen, <span class="dt">gr=</span><span class="ot">NULL</span>, <span class="dt">control=</span><span class="kw">list</span>(<span class="dt">trace=</span><span class="dv">0</span>)))</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true"></a><span class="kw">print</span>(tlF)</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true"></a><span class="kw">print</span>(myop)</span></code></pre></div>
<p>In this example, Fortran execution was actually SLOWER than plain R on the system where it was run.</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="unnumbered">References</h2>
<div id="refs" class="references hanging-indent">
<div id="ref-Byrd1995">
<p>Byrd, Richard H., Peihuang Lu, Jorge Nocedal, and Ciyou Zhu. 1995a. “A Limited Memory Algorithm for Bound Constrained Optimization.” <em>SIAM J. Sci. Comput.</em> 16 (5): 1190–1208. <a href="https://doi.org/10.1137/0916069">https://doi.org/10.1137/0916069</a>.</p>
</div>
<div id="ref-Byrd95">
<p>Byrd, Richard H., Peihuang Lu, Jorge Nocedal, and Ci You Zhu. 1995b. “A Limited Memory Algorithm for Bound Constrained Optimization.” <em>SIAM Journal on Scientific Computing</em> 16 (5): 1190–1208.</p>
</div>
<div id="ref-Coppola2014">
<p>Coppola, Antonio, Brandon Stewart, and Naoaki Okazaki. 2014. <em>Lbfgs: Limited-Memory Bfgs Optimization</em>. <a href="https://CRAN.R-project.org/package=lbfgs">https://CRAN.R-project.org/package=lbfgs</a>.</p>
</div>
<div id="ref-RCppDE2013">
<p>Eddelbuettel, Dirk. 2013. <em>Seamless R and C++ Integration with Rcpp</em>. New York: Springer. <a href="https://doi.org/10.1007/978-1-4614-6868-4">https://doi.org/10.1007/978-1-4614-6868-4</a>.</p>
</div>
<div id="ref-RCppDEJJB2017">
<p>Eddelbuettel, Dirk, and James Joseph Balamuta. 2017. “Extending extitR with extitC++: A Brief Introduction to extitRcpp.” <em>PeerJ Preprints</em> 5 (August): e3188v1. <a href="https://doi.org/10.7287/peerj.preprints.3188v1">https://doi.org/10.7287/peerj.preprints.3188v1</a>.</p>
</div>
<div id="ref-RCppDERF2011">
<p>Eddelbuettel, Dirk, and Romain François. 2011. “Rcpp: Seamless R and C++ Integration.” <em>Journal of Statistical Software</em> 40 (8): 1–18. <a href="https://doi.org/10.18637/jss.v040.i08">https://doi.org/10.18637/jss.v040.i08</a>.</p>
</div>
<div id="ref-lbfgsb3cMF">
<p>Fidler, Matthew L, John C Nash, Ciyou Zhu, Richard Byrd, Jorge Nocedal, and Jose Luis Morales. 2018. <em>lbfgsb3c: Limited Memory Bfgs Minimizer with Bounds on Parameters with Optim() ’c’ Interface</em>. <a href="https://CRAN.R-project.org/package=lbfgsb3c">https://CRAN.R-project.org/package=lbfgsb3c</a>.</p>
</div>
<div id="ref-LiuN89">
<p>Liu, Dong C., and Jorge Nocedal. 1989. “On the Limited Memory BFGS Method for Large Scale Optimization.” <em>Math. Program.</em> 45 (1-3): 503–28. <a href="https://doi.org/10.1007/BF01589116">https://doi.org/10.1007/BF01589116</a>.</p>
</div>
<div id="ref-Lu94limitedmemory">
<p>Lu, Peihuang, Jorge Nocedal, Ciyou Zhu, and Richard H. Byrd. 1994. “A Limited-Memory Algorithm for Bound Constrained Optimization.” <em>SIAM Journal on Scientific Computing</em> 16: 1190–1208.</p>
</div>
<div id="ref-Morales2011">
<p>Morales, José Luis, and Jorge Nocedal. 2011. “Remark on Algorithm 778: L-BFGS-B: Fortran subroutines for large-scale bound constrained optimization.” <em>ACM Trans. Math. Softw.</em> 38 (1): 7:1–7:4. <a href="https://doi.acm.org/10.1145/2049662.2049669">https://doi.acm.org/10.1145/2049662.2049669</a>.</p>
</div>
<div id="ref-lbfgsb3JN">
<p>Nash, John C, Ciyou Zhu, Richard Byrd, Jorge Nocedal, and Jose Luis Morales. 2015. <em>lbfgsb3: Limited Memory Bfgs Minimizer with Bounds on Parameters</em>. <a href="https://CRAN.R-project.org/package=lbfgsb3">https://CRAN.R-project.org/package=lbfgsb3</a>.</p>
</div>
<div id="ref-Zhu1997LBFGS">
<p>Zhu, Ciyou, Richard H. Byrd, Peihuang Lu, and Jorge Nocedal. 1997. “Algorithm 778: L-BFGS-B: Fortran Subroutines for Large-Scale Bound-Constrained Optimization.” <em>ACM Trans. Math. Softw.</em> 23 (4): 550–60. <a href="https://doi.org/10.1145/279232.279236">https://doi.org/10.1145/279232.279236</a>.</p>
</div>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
